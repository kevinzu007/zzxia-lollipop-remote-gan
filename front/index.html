<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
  <title>Document</title>
  <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
  <script src="https://cdn.staticfile.org/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style type="text/css">
    @font-face {
      font-family: 'cour';
      font-style: normal;
      font-weight: normal;
      font-display: auto;
      src: url('./cour.ttf') format('truetype');
    }
    * {
      padding: 0;
      margin: 0;
    }
    html, body {
      width: 100%;
      height: 100%;
    }
    html {
      font-family: fangsong;
      color: #fff;
    }
    body {
      display: flex;
      flex-direction: column;
    }
    .meinv-bg {
      width: 100%;
      height: 100%;
      background: url('./girl.jpg') no-repeat;
      background-position: center top;
    }
    .text-content {
      position: absolute;
      left: 0;
      right: 0;
      width: 100%;
      height: 100%;
      overflow-y: auto;
    }
    h1 {
      text-align: center;
      color: rgb(191, 229, 235);
      font-size: 50px;
    }
    .login-status-icon {
      display: none;
      color: #00FF00;
      font-size: 16px;
      font-weight: bold;
      margin-left: 10px;
      vertical-align: bottom;
      text-shadow: 0 0 3px rgba(0, 255, 0, 0.8), 1px 1px 2px rgba(0, 0, 0, 0.8);
    }
    .login-status-icon.show {
      display: inline-block;
    }
    /* ç§»åŠ¨ç«¯è°ƒæ•´ */
    @media only screen and (max-width: 750px) {
      .login-status-icon {
        font-size: 14px;
        margin-left: 8px;
      }
    }
    /* çŒªçŒªä¾  */
    .pig-runner {
      position: absolute;
      left: 20px;
      top: 20px;
      width: 80px;
      height: 80px;
      cursor: pointer;
      user-select: none;
      transition: left 2s linear, top 2s linear, transform 0.3s ease;
      z-index: 9;
      object-fit: contain;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
    }
    .pig-runner img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      image-rendering: auto;
    }
    select, input, textarea {
      font-family: fangsong;
      width: 250px;
      font-size: 20px;
      min-height: 30px;
      box-sizing: border-box;
      opacity: 0.9;
      border: none;
      outline: none;
      padding: 0 10px;
    }
    textarea {
      padding: 10px;
      resize: none;
    }
    .cell {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    .cell label {
      margin-right: 20px;
      font-size: 20px;
      width: 150px;
    }
    .require label::after {
      content: '*';
      color: #e9f539;
    }

    .textarea-cell {
      align-items: flex-start;
    }

    .gan-btn {
      margin: 30px auto;
      display: block;
      color: #fff;
      outline: none;
      border: none;
      text-align: center;
      font-family: fangsong;
      cursor: pointer;
      background-color: rgb(255, 255, 0, 0.7);
      font-weight: 600;
    }

    #text {
      width: 100%;
      overflow-x: auto;
      white-space: nowrap;
      box-sizing: border-box;
    }
    
    /* ç§»åŠ¨ç«¯æ ·å¼ */
    @media only screen and (max-width: 750px) {
      h1 {
        font-size: 25px;
        margin: 30px 20px;
      }
      .cell-content {
        padding: 0 20px;
      }
      .cell {
        margin-bottom: 10px;
      }

      select, input, textarea {
        font-size: 16px;
        width: 200px;
        min-height: 25px;
      } 

      textarea {
        resize: none;
        height: 100px;
      }

      .cell label {
        font-size: 16px;
        width: 100px;
      }
      .gan-btn {
        width: 150px;
        height: 40px;
        border-radius: 8px;
        font-size: 24px;
      }
    }
    /* pcç«¯æ ·å¼ */
    @media only screen and (min-width: 760px) {
      .cell-content {
        display: flex;
        width: max-content;
        margin: 0 auto;
      }
      h1 {
        margin: 30px 50px 50px;
      }
      .left-cell {
        margin-right: 80px;
      }
      .right-cell {
        height: inherit;
      }
      .textarea-cell, .textarea-cell textarea {
        height: 100%;
      }
      .last-child {
        margin-bottom: 0;
      }
      .gan-btn {
        width: 300px;
        height: 50px;
        border-radius: 10px;
        font-size: 26px;
      }
      #text {
        padding: 20px 40px;
      }
    }
    
    /* ç™»å½•å¼¹çª— */
    .modal-mask {
      display: none;
      position: fixed;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.35);
      z-index: 20;
      align-items: center;
      justify-content: center;
    }
    .modal {
      width: 320px;
      background: #fefefe;
      border-radius: 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
      padding: 20px;
      color: #333;
      font-family: "Segoe UI", sans-serif;
    }
    .modal h3 {
      margin: 0 0 12px;
      text-align: center;
      color: #444;
    }
    .modal .form-item {
      display: flex;
      flex-direction: column;
      margin-bottom: 12px;
      font-size: 14px;
    }
    .modal input {
      width: 100%;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 8px 10px;
      font-size: 14px;
      font-family: inherit;
      box-sizing: border-box;
    }
    .modal .btn-row {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 10px;
    }
    .modal button {
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }
    .btn-cancel { background: #f0f0f0; color: #333; }
    .btn-ok { background: #ffd84d; color: #3a2a00; }
  </style>
</head>
<body>
    <div class="meinv-bg"></div>
    <div class="text-content">
      <div id="pig" class="pig-runner" title="ç‚¹æˆ‘ç™»é™†/æŸ¥çœ‹çŠ¶æ€">
        <img src="./fly.webp" alt="çŒªçŒªä¾ " />
      </div>
      <h1>è¶…çº§æ— æ•Œæ£’æ£’ç³–<span id="loginStatusIcon" class="login-status-icon">âœ“</span></h1>
      <div class="cell-content">
        <div class="left-cell">
          <p class="cell require">
            <label>1ã€å¹²</label>
            <select id="do">
              <option value="" style="display:none"></option>
              <option value="build">build</option>
              <option value="deploy">deploy</option>
              <option value="gogogo">gogogo</option>
            </select>
          </p>
      
          <p class="cell require">
            <label>2ã€è¿è¡Œç¯å¢ƒ</label>
            <select id="env">
              <option value="" style="display:none"></option>
              <option value="dev">dev</option>
              <option value="stag">stag</option>
              <option value="prod">prod</option>
            </select>
          </p>
      
          <p class="cell">
            <label>3ã€ä»£ç åˆ†æ”¯</label>
            <input id="branch" type="text">
          </p>
      
          <p class="cell">
            <label>4ã€å‘å¸ƒç‰ˆæœ¬</label>
            <input id="version" type="text">
          </p>
      
          <p class="cell">
            <label>5ã€ç°åº¦å‘å¸ƒ</label>
            <select id="gray">
              <option value="no">no</option>
              <option value="yes">yes</option>
            </select>
          </p>
      
          <p class="cell">
            <label>6ã€è·³è¿‡æµ‹è¯•</label>
            <select id="skiptest">
              <option value="no">no</option>
              <option value="yes">yes</option>
            </select>
          </p>
      
          <p class="cell">
            <label>7ã€å¼ºåˆ¶æ„å»º</label>
            <select id="force">
              <option value="no">no</option>
              <option value="yes">yes</option>
            </select>
          </p>
      
          <p class="cell last-child">
            <label>8ã€é¡¹ç›®ç±»åˆ«</label>
            <select id="category">
              <option value="" style="display:none"></option>
              <option value="java">java</option>
              <option value="node">node</option>
              <option value="dockerfile">dockerfile</option>
            </select>
          </p>
        </div>
        <div class="right-cell">
          <p class="cell require textarea-cell">
            <label>9ã€é¡¹ç›®åˆ—è¡¨</label>
            <textarea id="projects" cols="30" rows="10" placeholder="ä¸€ä¸ªé¡¹ç›®ä¸€è¡Œ"></textarea>
          </p>
        </div>
      </div>
      <button class="gan-btn" onclick="start()">å¼€ å¹²</button>
      <div id="text"></div>
    </div>
    
  </div>
  <!-- ç™»å½•å¼¹çª— -->
  <div id="modalMask" class="modal-mask">
    <div class="modal">
      <h3>ç™»å½•ä¸€ä¸‹</h3>
      <div class="form-item">
        <label>ç”¨æˆ·å</label>
        <input id="loginUser" type="text" placeholder="ä¾‹å¦‚ kevin" />
      </div>
      <div class="form-item">
        <label>å¯†ç </label>
        <input id="loginSec" type="password" placeholder="è¯·è¾“å…¥å¯†ç " />
      </div>
      <div class="btn-row">
        <button class="btn-cancel" id="loginCancel">å–æ¶ˆ</button>
        <button class="btn-ok" id="loginOk">ç¡®å®š</button>
      </div>
    </div>
  </div>
 <script>
  // ------------- çŠ¶æ€ -------------
  let isLoggedIn = false
  let currentUser = ''
  let currentToken = ''
  let currentSec = ''

  const pigEl = document.getElementById('pig')
  const modalMask = document.getElementById('modalMask')
  const loginUserEl = document.getElementById('loginUser')
  const loginSecEl = document.getElementById('loginSec')
  const loginStatusIcon = document.getElementById('loginStatusIcon')

  // æ›´æ–°ç™»å½•çŠ¶æ€å›¾æ ‡
  function updateLoginStatusIcon(show) {
    if (!loginStatusIcon) return
    if (show && isLoggedIn) {
      loginStatusIcon.classList.add('show')
    } else {
      loginStatusIcon.classList.remove('show')
    }
  }

  // ä»æœ¬åœ°æ¢å¤
  ;(() => {
    const saved = JSON.parse(localStorage.getItem('gan_login') || '{}')
    if (saved.user && saved.token) {
      isLoggedIn = true
      currentUser = saved.user
      currentToken = saved.token
      currentSec = saved.sec || ''
      updateLoginStatusIcon(true)
    }
  })()

  // ------------- çŒªçŒªä¾ è·‘åŠ¨ -------------
  let pigTimer = null
  let targetX = 20
  let targetY = 20
  
  function movePig() {
    const areaW = window.innerWidth - 100
    const areaH = window.innerHeight - 120
    // è®¾ç½®æ–°çš„ç›®æ ‡ä½ç½®
    targetX = Math.max(10, Math.random() * areaW)
    targetY = Math.max(10, Math.random() * areaH)
    // é€šè¿‡ CSS transition å¹³æ»‘ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®
    pigEl.style.left = targetX + 'px'
    pigEl.style.top = targetY + 'px'
    // éšæœºæ—‹è½¬å’Œç¼©æ”¾ï¼Œä½†å˜åŒ–æ›´å¹³æ»‘
    const scale = 0.9 + Math.random() * 0.2
    const rotate = Math.random() * 20 - 10
    pigEl.style.transform = `scale(${scale}) rotate(${rotate}deg)`
  }
  function startRun() {
    if (pigTimer) return
    movePig()
    // æ¯2ç§’ç§»åŠ¨åˆ°æ–°ä½ç½®ï¼Œä¸ CSS transition æ—¶é—´åŒ¹é…
    pigTimer = setInterval(movePig, 2000)
  }
  function stopRun() {
    if (pigTimer) {
      clearInterval(pigTimer)
      pigTimer = null
    }
  }
  pigEl.addEventListener('mouseenter', stopRun)
  pigEl.addEventListener('mouseleave', startRun)

  pigEl.addEventListener('click', () => {
    if (isLoggedIn) {
      alert('ä½ å·²ç™»å½•ï¼Œèµ°å¼€ï¼')
    } else {
      openLogin()
    }
  })

  // ------------- ç™»å½•å¼¹çª— -------------
  function openLogin() {
    modalMask.style.display = 'flex'
    loginUserEl.value = currentUser || ''
    loginSecEl.value = ''
    setTimeout(() => loginUserEl.focus(), 0)
  }
  function closeLogin() {
    modalMask.style.display = 'none'
  }
  document.getElementById('loginCancel').onclick = closeLogin
  // å›è½¦é”®æäº¤
  loginSecEl.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      document.getElementById('loginOk').click()
    }
  })
  document.getElementById('loginOk').onclick = function() {
    const u = loginUserEl.value.trim()
    const s = loginSecEl.value.trim()
    if (!u || !s) {
      alert('è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç ')
      return
    }
    // è®¡ç®— sha1(ç”¨æˆ·å+å¯†ç )ï¼Œä¸åç«¯å¯†ç ç”Ÿæˆå·¥å…·ä¿æŒä¸€è‡´
    const secSha1 = CryptoJS.SHA1(u + s).toString()
    // è°ƒç”¨åç«¯æ¥å£éªŒè¯ç”¨æˆ·åå¯†ç å¹¶è·å–token
    $.ajax({
      type: 'POST',
      url: 'http://127.0.0.1:9527/get/token',
      headers: {
        user: u,
        sec: secSha1
      },
      success: function (response) {
        if (response.Status === 'Success' && response.Token) {
          isLoggedIn = true
          currentUser = u
          currentToken = response.Token
          currentSec = secSha1
          localStorage.setItem('gan_login', JSON.stringify({user: u, token: response.Token, sec: secSha1}))
          closeLogin()
          updateLoginStatusIcon(true)
        } else {
          alert('ç™»å½•å¤±è´¥ï¼š' + (response.Message || 'æœªçŸ¥é”™è¯¯'))
        }
      },
      error: function (xhr) {
        let msg = 'ç™»å½•å¤±è´¥'
        if (xhr.responseJSON && xhr.responseJSON.Message) {
          msg += 'ï¼š' + xhr.responseJSON.Message
        }
        alert(msg)
      }
    })
  }

  // ç‚¹å‡»é®ç½©å…³é—­
  modalMask.addEventListener('click', (e) => {
    if (e.target === modalMask) closeLogin()
  })

  // ------------- å¼€å¹² -------------
  function start() {
    let doValue = $('#do option:selected').val()
    if (!doValue) return window.alert('è¯·é€‰æ‹©"å¹²"')

    let env = $('#env option:selected').val()
    if (!env) return window.alert('è¯·é€‰æ‹©è¿è¡Œç¯å¢ƒ')

    let projects = $('#projects').val()
    if (!projects) return window.alert('è¯·è¾“å…¥é¡¹ç›®åˆ—è¡¨')

    if (!isLoggedIn) {
      openLogin()
      return
    }

    $('#text').html('å¹²ing....')
    $.ajax({
      type: 'POST',
      url: 'http://127.0.0.1:9527/hook/hand',
      data: JSON.stringify({
          do: doValue,
          env: env,
          branch: $('#branch').val(),
          version: $('#version').val(),
          gray: $('#gray option:selected').val() || '',
          skiptest: $('#skiptest option:selected').val() || '',
          force: $('#force option:selected').val() || '',
          category: $('#category option:selected').val() || '',
          projects: projects.split(/[\r\n]/)
      }),
      headers: {
        token: currentToken || ''
      },
      contentType: 'application/json',
      success: function (response) {
        let str = response
        str = str.replace(/ /g, '&nbsp;').replace(/[\r\n]/g, '<br/>').replace(/\[.*?m/g, '').replace(//g, '')
        console.log('str', str)
        $('#text').html(str)
      },
      // xhræ˜¯ajaxå¯¹è±¡
      error: function (xhr) {
        console.log('xhr', xhr)
        $('#text').html('å¹²å¤±è´¥äº†')
      }
    });
  }
  // å¯åŠ¨å°çŒªè·‘åŠ¨
  startRun()
 </script>
</body>
</html>
