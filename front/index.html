<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport"
    content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
  <title>Document</title>
  <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
  <script src="https://cdn.staticfile.org/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="./config.js"></script>
  <style type="text/css">
    @font-face {
      font-family: 'cour';
      font-style: normal;
      font-weight: normal;
      font-display: auto;
      src: url('./cour.ttf') format('truetype');
    }

    * {
      padding: 0;
      margin: 0;
    }

    html,
    body {
      width: 100%;
      height: 100%;
    }

    html {
      font-family: fangsong;
      color: #fff;
    }

    body {
      display: flex;
      flex-direction: column;
    }

    .meinv-bg {
      width: 100%;
      height: 100%;
      background: url('./girl.jpg') no-repeat;
      background-position: center top;
    }

    .text-content {
      position: absolute;
      left: 0;
      right: 0;
      width: 100%;
      height: 100%;
      overflow-y: auto;
    }

    h1 {
      text-align: center;
      color: rgb(191, 229, 235);
      font-size: 50px;
    }

    .login-status-icon {
      display: none;
      color: #00FF00;
      font-size: 16px;
      font-weight: bold;
      margin-left: 10px;
      vertical-align: bottom;
      text-shadow: 0 0 3px rgba(0, 255, 0, 0.8), 1px 1px 2px rgba(0, 0, 0, 0.8);
    }

    .login-status-icon.show {
      display: inline-block;
    }

    /* 移动端调整 */
    @media only screen and (max-width: 750px) {
      .login-status-icon {
        font-size: 14px;
        margin-left: 8px;
      }
    }

    /* 提示消息 */
    .toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.8);
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
      color: white;
      padding: 20px 32px;
      border-radius: 16px;
      box-shadow: 0 12px 40px rgba(255, 107, 107, 0.5);
      z-index: 1000;
      font-size: 16px;
      font-weight: 500;
      min-width: 300px;
      max-width: 90%;
      text-align: center;
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .toast.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
      pointer-events: auto;
    }

    .toast-icon {
      font-size: 24px;
      flex-shrink: 0;
    }

    .toast-message {
      flex: 1;
    }

    @media only screen and (max-width: 750px) {
      .toast {
        min-width: 280px;
        padding: 18px 24px;
        font-size: 15px;
      }

      .toast-icon {
        font-size: 22px;
      }
    }

    /* 猪猪侠 */
    .pig-runner {
      position: absolute;
      left: 20px;
      top: 20px;
      width: 80px;
      height: 80px;
      cursor: pointer;
      user-select: none;
      transition: left 2s linear, top 2s linear, transform 0.3s ease;
      z-index: 9;
      object-fit: contain;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
    }

    .pig-runner img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      image-rendering: auto;
    }

    select,
    input,
    textarea {
      font-family: fangsong;
      width: 250px;
      font-size: 20px;
      min-height: 30px;
      box-sizing: border-box;
      opacity: 0.9;
      border: none;
      outline: none;
      padding: 0 10px;
    }

    textarea {
      padding: 10px;
      resize: none;
    }

    .cell {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }

    .cell label {
      margin-right: 20px;
      font-size: 20px;
      width: 150px;
    }

    .require label::after {
      content: '*';
      color: #e9f539;
    }

    .require-one label::after {
      content: '①';
      color: #e9f539;
      font-size: 50%;
      vertical-align: top;
      font-weight: bold;
    }

    .textarea-cell {
      align-items: flex-start;
    }

    .gan-btn {
      margin: 30px auto;
      display: block;
      color: #fff;
      outline: none;
      border: none;
      text-align: center;
      font-family: fangsong;
      cursor: pointer;
      background-color: rgb(255, 255, 0, 0.7);
      font-weight: 600;
    }

    #text {
      width: 100%;
      overflow-x: auto;
      white-space: nowrap;
      box-sizing: border-box;
    }

    /* 移动端样式 */
    @media only screen and (max-width: 750px) {
      h1 {
        font-size: 25px;
        margin: 30px 20px;
      }

      .cell-content {
        padding: 0 20px;
      }

      .cell {
        margin-bottom: 10px;
      }

      select,
      input,
      textarea {
        font-size: 16px;
        width: 200px;
        min-height: 25px;
      }

      textarea {
        resize: none;
        height: 100px;
      }

      .cell label {
        font-size: 16px;
        width: 100px;
      }

      .gan-btn {
        width: 150px;
        height: 40px;
        border-radius: 8px;
        font-size: 24px;
      }
    }

    /* pc端样式 */
    @media only screen and (min-width: 760px) {
      .cell-content {
        display: flex;
        width: max-content;
        margin: 0 auto;
      }

      h1 {
        margin: 30px 50px 50px;
      }

      .left-cell {
        margin-right: 80px;
      }

      .right-cell {
        height: inherit;
        display: flex;
        flex-direction: column;
      }


      .textarea-cell {
        flex: 1;
        height: auto;
      }

      .textarea-cell,
      .textarea-cell textarea {
        height: 100%;
      }

      .last-child {
        margin-bottom: 0;
      }

      .gan-btn {
        width: 300px;
        height: 50px;
        border-radius: 10px;
        font-size: 26px;
      }

      #text {
        padding: 20px 40px;
      }

      .form-container {
        width: max-content;
        margin: 0 auto;
      }

      .cell-content {
        /* margin: 0 auto; removed */
      }

      .extra-cell {
        width: 100%;
      }

      #extra {
        width: auto;
        /* Will take remaining space in flex container */
        flex: 1;
      }

      /* override generic input width for extra */
      .extra-cell .cell input {
        width: auto;
      }
    }

    /* 登录弹窗 */
    .modal-mask {
      display: none;
      position: fixed;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.35);
      z-index: 20;
      align-items: center;
      justify-content: center;
    }

    .modal {
      width: 320px;
      background: #fefefe;
      border-radius: 12px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
      padding: 20px;
      color: #333;
      font-family: "Segoe UI", sans-serif;
    }

    .modal h3 {
      margin: 0 0 12px;
      text-align: center;
      color: #444;
    }

    .modal .form-item {
      display: flex;
      flex-direction: column;
      margin-bottom: 12px;
      font-size: 14px;
    }

    .modal input {
      width: 100%;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 8px 10px;
      font-size: 14px;
      font-family: inherit;
      box-sizing: border-box;
    }

    .modal .btn-row {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 10px;
    }

    .modal button {
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }

    .btn-cancel {
      background: #f0f0f0;
      color: #333;
    }

    .btn-ok {
      background: #ffd84d;
      color: #3a2a00;
    }

    .disabled-cell {
      opacity: 0.5;
      background-color: rgba(255, 255, 255, 0.5) !important;
      color: #333;
      pointer-events: none;
      filter: grayscale(1);
    }
  </style>
</head>

<body>
  <div class="meinv-bg"></div>
  <div class="text-content">
    <div id="pig" class="pig-runner" title="点我登陆/查看状态">
      <img src="./fly.webp" alt="猪猪侠" />
    </div>
    <h1>超级无敌棒棒糖<span id="loginStatusIcon" class="login-status-icon">✓</span></h1>
    <div class="form-container">
      <div class="cell-content">
        <div class="left-cell">
          <p class="cell require">
            <label>1、干</label>
            <select id="do">
              <option value="" style="display:none"></option>
              <option value="build">build</option>
              <option value="deploy">deploy</option>
              <option value="gogogo">gogogo</option>
            </select>
          </p>

          <p class="cell require">
            <label>2、运行环境</label>
            <select id="env"></select>
          </p>

          <p class="cell">
            <label>3、代码分支</label>
            <input id="branch" type="text">
          </p>

          <p class="cell">
            <label>4、发布版本</label>
            <input id="version" type="text">
          </p>

          <p class="cell">
            <label>5、灰度发布</label>
            <select id="gray">
              <option value="no">no</option>
              <option value="yes">yes</option>
            </select>
          </p>

          <p class="cell">
            <label>6、跳过测试</label>
            <select id="skiptest">
              <option value="no">no</option>
              <option value="yes">yes</option>
            </select>
          </p>

          <p class="cell">
            <label>7、强制构建</label>
            <select id="force">
              <option value="no">no</option>
              <option value="yes">yes</option>
            </select>
          </p>

          </select>
          </p>
        </div>
        <div class="right-cell">
          <p class="cell require-one">
            <label>8、项目类别</label>
            <select id="category"></select>
          </p>

          <p class="cell require-one textarea-cell">
            <label>9、项目列表</label>
            <textarea id="projects" placeholder="一个项目一行"></textarea>
          </p>
        </div>
      </div>
      <div class="extra-cell">
        <p class="cell">
          <label>A、附加参数</label>
          <input id="extra" type="text" placeholder="shell附加参数">
        </p>
      </div>
    </div>
    <button class="gan-btn" onclick="start()">开 干</button>
    <div id="text"></div>
  </div>

  </div>
  <!-- 登录弹窗 -->
  <div id="modalMask" class="modal-mask">
    <div class="modal">
      <h3>你谁啊？</h3>
      <div class="form-item">
        <label>用户名</label>
        <input id="loginUser" type="text" placeholder="例如 kevin" />
      </div>
      <div class="form-item">
        <label>密码</label>
        <input id="loginSec" type="password" placeholder="请输入密码" />
      </div>
      <div class="btn-row">
        <button class="btn-cancel" id="loginCancel">取消</button>
        <button class="btn-ok" id="loginOk">确定</button>
      </div>
    </div>
  </div>
  <!-- 提示消息 -->
  <div id="toast" class="toast">
    <span class="toast-icon">⚠️</span>
    <span class="toast-message"></span>
  </div>
  <script>
    // ------------- 状态 -------------
    let isLoggedIn = false
    let currentUser = ''
    let currentToken = ''
    let currentSec = ''

    const pigEl = document.getElementById('pig')
    const modalMask = document.getElementById('modalMask')
    const loginUserEl = document.getElementById('loginUser')
    const loginSecEl = document.getElementById('loginSec')
    const loginStatusIcon = document.getElementById('loginStatusIcon')
    const toast = document.getElementById('toast')
    const toastMessage = toast.querySelector('.toast-message')

    // ------------- 初始化配置 -------------
    let currentBackendUrl = ''

    function initEnv() {
      const envSelect = document.getElementById('env')
      const doSelect = document.getElementById('do')

      // Dynamic form state
      function updateFormState() {
        const doValue = doSelect.value
        // Fields to disable when build: 4 (version), 5 (gray)
        const versionInput = document.getElementById('version')
        const graySelect = document.getElementById('gray')
        const versionCell = versionInput.parentElement // .cell
        const grayCell = graySelect.parentElement // .cell

        if (doValue === 'build') {
          versionInput.classList.add('disabled-cell')
          graySelect.classList.add('disabled-cell')
          versionInput.disabled = true
          graySelect.disabled = true
          // Optional: clear values? Maybe keeping them is better for UX if they switch back
        } else {
          versionInput.classList.remove('disabled-cell')
          graySelect.classList.remove('disabled-cell')
          versionInput.disabled = false
          graySelect.disabled = false
        }
      }

      doSelect.addEventListener('change', updateFormState)
      // Call once
      updateFormState()

      if (!window.ganConfig || !window.ganConfig.envs) return

      envSelect.innerHTML = ''
      window.ganConfig.envs.forEach((item, index) => {
        const opt = document.createElement('option')
        opt.value = index // Use index to map back to config
        opt.textContent = item.name
        envSelect.appendChild(opt)
      })

      // Default select first
      if (window.ganConfig.envs.length > 0) {
        currentBackendUrl = window.ganConfig.envs[0].url
      }

      // Update backend url on change
      envSelect.addEventListener('change', (e) => {
        const idx = e.target.value
        if (window.ganConfig.envs[idx]) {
          currentBackendUrl = window.ganConfig.envs[idx].url
          // clear login status when switching env if needed? 
          // For now let's keep it simple, user might need to relogin if token invalid
        }
      })

      // Populate categories
      if (window.ganConfig.categories) {
        const catSelect = document.getElementById('category')
        catSelect.innerHTML = ''
        window.ganConfig.categories.forEach(cat => {
          const opt = document.createElement('option')
          opt.value = cat
          opt.textContent = cat || '' // Display empty for empty string (or user might want a label like 'None'?)
          // User said "Empty option exists", effectively <option value=""></option>
          catSelect.appendChild(opt)
        })
      }
    }

    initEnv()

    // 显示提示消息
    function showToast(message, duration = 3000) {
      toastMessage.textContent = message
      toast.classList.add('show')
      setTimeout(() => {
        toast.classList.remove('show')
      }, duration)
    }

    // 更新登录状态图标
    function updateLoginStatusIcon(show) {
      if (!loginStatusIcon) return
      if (show && isLoggedIn) {
        loginStatusIcon.classList.add('show')
      } else {
        loginStatusIcon.classList.remove('show')
      }
    }

    // 从本地恢复
    ; (() => {
      const saved = JSON.parse(localStorage.getItem('gan_login') || '{}')
      if (saved.user && saved.token) {
        isLoggedIn = true
        currentUser = saved.user
        currentToken = saved.token
        currentSec = saved.sec || ''
        updateLoginStatusIcon(true)
      }
    })()

    // ------------- 猪猪侠跑动 -------------
    let pigTimer = null
    let targetX = 20
    let targetY = 20

    function movePig() {
      const areaW = window.innerWidth - 100
      const areaH = window.innerHeight - 120
      // 设置新的目标位置
      targetX = Math.max(10, Math.random() * areaW)
      targetY = Math.max(10, Math.random() * areaH)
      // 通过 CSS transition 平滑移动到目标位置
      pigEl.style.left = targetX + 'px'
      pigEl.style.top = targetY + 'px'
      // 随机旋转和缩放，但变化更平滑
      const scale = 0.9 + Math.random() * 0.2
      const rotate = Math.random() * 20 - 10
      pigEl.style.transform = `scale(${scale}) rotate(${rotate}deg)`
    }
    function startRun() {
      if (pigTimer) return
      movePig()
      // 每2秒移动到新位置，与 CSS transition 时间匹配
      pigTimer = setInterval(movePig, 2000)
    }
    function stopRun() {
      if (pigTimer) {
        clearInterval(pigTimer)
        pigTimer = null
      }
    }
    pigEl.addEventListener('mouseenter', stopRun)
    pigEl.addEventListener('mouseleave', startRun)

    pigEl.addEventListener('click', () => {
      if (isLoggedIn) {
        showToast('你已登录，走开！')
      } else {
        openLogin()
      }
    })

    // ------------- 登录弹窗 -------------
    function openLogin() {
      modalMask.style.display = 'flex'
      loginUserEl.value = currentUser || ''
      loginSecEl.value = ''
      setTimeout(() => loginUserEl.focus(), 0)
    }
    function closeLogin() {
      modalMask.style.display = 'none'
    }
    document.getElementById('loginCancel').onclick = closeLogin
    // 回车键提交
    loginSecEl.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        document.getElementById('loginOk').click()
      }
    })
    document.getElementById('loginOk').onclick = function () {
      const u = loginUserEl.value.trim()
      const s = loginSecEl.value.trim()
      if (!u || !s) {
        showToast('请填写用户名和密码')
        return
      }
      // 计算 sha1(用户名+密码)，与后端密码生成工具保持一致
      const secSha1 = CryptoJS.SHA1(u + s).toString()
      // 调用后端接口验证用户名密码并获取token
      $.ajax({
        type: 'POST',
        url: currentBackendUrl + '/get/token',
        headers: {
          user: u,
          sec: secSha1
        },
        success: function (response) {
          if (response.Status === 'Success' && response.Token) {
            isLoggedIn = true
            currentUser = u
            currentToken = response.Token
            currentSec = secSha1
            localStorage.setItem('gan_login', JSON.stringify({ user: u, token: response.Token, sec: secSha1 }))
            closeLogin()
            updateLoginStatusIcon(true)
          } else {
            showToast('登录失败：' + (response.Message || '未知错误'))
          }
        },
        error: function (xhr) {
          let msg = '登录失败'
          if (xhr.responseJSON && xhr.responseJSON.Message) {
            msg += '：' + xhr.responseJSON.Message
          } else if (xhr.status === 0) {
            msg += '：无法连接到服务器'
          } else {
            msg += '：网络错误'
          }
          showToast(msg)
        }
      })
    }

    // 点击遮罩关闭
    modalMask.addEventListener('click', (e) => {
      if (e.target === modalMask) closeLogin()
    })

    // ------------- 开干 -------------
    async function start() {
      let doValue = $('#do option:selected').val()
      if (!doValue) return showToast('请选择"干"')

      let env = $('#env option:selected').val()
      if (!env) return showToast('请选择运行环境')

      // Clean projects: split -> trim -> remove empty -> remove all internal spaces
      let projectsRaw = $('#projects').val() || ''
      let projectList = projectsRaw.split(/[\r\n]+/)
        .map(p => p.trim().replace(/\s+/g, ''))
        .filter(p => p.length > 0)

      let category = $('#category option:selected').val()

      // Validate: at least one of category or projects
      if (!category && projectList.length === 0) {
        return showToast('请选择"项目类别" 或 输入"项目列表" (二选一)')
      }

      // Resolve Env config
      const envIdx = $('#env').val()
      const envConfig = window.ganConfig.envs[envIdx]
      if (!envConfig) return showToast('配置错误')

      const targetUrl = envConfig.url
      const realEnvValue = envConfig.value

      if (!isLoggedIn) {
        openLogin()
        return
      }

      const textEl = document.getElementById('text')
      textEl.innerHTML = '干ing....<br/>'

      try {
        const response = await fetch(targetUrl + '/hook/hand', {
          method: 'POST',
          headers: {
            'token': currentToken || '',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            do: doValue,
            env: realEnvValue,
            branch: $('#branch').val(),
            version: $('#version').val(),
            gray: $('#gray option:selected').val() || '',
            skiptest: $('#skiptest option:selected').val() || '',
            force: $('#force option:selected').val() || '',
            category: $('#category option:selected').val() || '',
            extra: $('#extra').val() || '',
            projects: projectList
          })
        })

        if (!response.ok) {
          const errText = await response.text()
          try {
            const errJson = JSON.parse(errText)
            showToast('干失败了：' + (errJson.Message || response.statusText))
          } catch (e) {
            showToast('干失败了：' + (errText || response.statusText))
          }
          textEl.innerHTML += '<br/>请求失败'
          return
        }

        const reader = response.body.getReader()
        const decoder = new TextDecoder()

        while (true) {
          const { done, value } = await reader.read()
          if (done) break
          let chunk = decoder.decode(value, { stream: true })

          // Basic HTML escape to prevent XSS (though content is logs)
          chunk = chunk.replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");

          // Remove ANSI codes
          chunk = chunk.replace(/\[.*?m/g, '')

          // Formatting: spaces to &nbsp;, newlines to <br/>
          chunk = chunk.replace(/ /g, '&nbsp;').replace(/[\r\n]/g, '<br/>')

          textEl.insertAdjacentHTML('beforeend', chunk)

          // Auto scroll
          const contentEl = document.querySelector('.text-content')
          if (contentEl) contentEl.scrollTop = contentEl.scrollHeight
        }

      } catch (err) {
        console.error(err)
        showToast('网络错误或执行中断')
        textEl.innerHTML += '<br/>执行出错'
      }
    }
    // 启动小猪跑动
    startRun()
  </script>
</body>

</html>